---
title: "Deploying"
description: "How to deploy and manage DevStride infrastructure."
---

# Deploying

## First Deployment

The fastest way to get a personal stage running is the automated setup wizard:

```bash
./ds init              # Configure environment (stage name, AWS profile, region)
./ds setup             # Full automated setup (Pulumi up, Neon DB branch, secrets, outputs)
```

The setup command handles everything: installing dependencies, creating the Pulumi stack, deploying infrastructure, provisioning a Neon database branch, populating secrets, and refreshing local environment variables.

### Manual First Deployment

If you prefer to run each step yourself:

```bash
# 1. Create the Pulumi stack and config file
pulumi stack init yourname -C infra

# 2. Set required config values
pulumi config set devstride:stage yourname -C infra
pulumi config set devstride:region us-east-1 -C infra
pulumi config set devstride:domain devstride.dev -C infra

# 3. Deploy (first run takes 5-10 minutes)
pulumi up -s yourname -C infra

# 4. Refresh local environment with stack outputs
./ds outputs
```

## Updating Infrastructure

After making changes to files in the `infra/` directory:

```bash
./ds infra run         # Runs pulumi up for your stage
```

Or directly with Pulumi:

```bash
pulumi up -s yourname -C infra
```

Pulumi compares the desired state (your code) against the current state (tracked in the Pulumi backend) and applies only the changes needed. Most updates complete in under a minute. Changes that affect Lambda code trigger esbuild rebundling -- the content-hash cache ensures only modified functions are rebuilt.

## Previewing Changes

Before deploying, preview what will change without actually modifying any resources:

```bash
pulumi preview -s yourname -C infra
```

Or with the `ds` CLI:

```bash
./ds infra run --preview
```

The preview output shows which resources will be created, updated, or deleted. This is especially useful before deploying changes that affect shared resources like DynamoDB tables or Cognito configuration.

## CI/CD Pipeline

The GitHub Actions workflow (`.github/workflows/deploy.yml`) handles all deployments to shared environments.

### Pipeline Flow

**On pull requests** (to `master` or `develop`):
1. **Preview** -- Runs `pulumi preview` and posts the diff as a PR comment. No resources are modified.

**On push to `develop`**:
1. **Migrations** -- Fetches `DB_CONNECTION_STRING` from Secrets Manager (`devstride/dev/config`) and runs `drizzle-kit migrate`
2. **Deploy** -- Runs `pulumi up` for the `dev` stack
3. **Frontend Build** -- Builds the Vue.js SPA with `VITE_*` environment variables populated from stack outputs and GitHub secrets
4. **Frontend Deploy** -- Syncs built assets to S3 with cache headers (immutable for hashed assets, no-cache for `index.html`), then invalidates the CloudFront distribution

**On push to `master`**:
1. Same steps as `develop`, but targeting the `prod` stack with the `production` GitHub environment (requires approval)

### Concurrency Protection

Both `dev` and `prod` deploy jobs use GitHub's concurrency groups with `cancel-in-progress: false`. This prevents two deployments from running simultaneously, which could corrupt Pulumi state. If a deployment is in progress, subsequent pushes queue until the current deployment completes.

::callout{type="info"}
Protected stages (`dev`, `prod`, `staging`) can only be deployed via CI/CD. The safety guard in `infra/index.ts` checks for the `CI=true` or `GITHUB_ACTIONS=true` environment variable and throws an error if a protected stage is deployed from a local machine. Personal stages are not affected by this restriction.
::

## Tearing Down

When you no longer need a personal stage, tear it down to stop all AWS costs:

```bash
./ds infra remove                 # Interactive teardown (prompts for confirmation)
```

The `remove` command:
1. Asks you to type your stage name to confirm
2. Runs `pulumi destroy` to delete all AWS resources
3. Deletes the Neon database branch
4. Removes the Pulumi stack state
5. Cleans up local caches (`.ds/bind/`, `infra/.build/`)

### Options

```bash
./ds infra remove --dry-run       # Preview what would be destroyed without deleting anything
./ds infra remove --keep-stack    # Destroy resources but keep the Pulumi stack state
```

### Manual Teardown

If you need to tear down directly with Pulumi:

```bash
pulumi destroy -s yourname -C infra    # Delete all resources
pulumi stack rm yourname -C infra      # Remove stack state (optional)
```

::callout{type="warning"}
Never run `pulumi destroy` on the `dev`, `prod`, or `staging` stacks. The safety guard will prevent this from local machines, but exercise caution if working directly with Pulumi in CI environments.
::
