---
title: "Safety Guards"
description: "Built-in protections for production and shared environments."
---

# Safety Guards

DevStride's infrastructure includes multiple layers of protection to prevent accidental damage to production and shared environments. These guards are enforced at deployment time in `infra/index.ts` and in the `ds` CLI.

## Stage Protection

Protected stages (`prod`, `dev`, `staging`) cannot be deployed from local machines. Only CI/CD pipelines -- identified by the `GITHUB_ACTIONS=true` or `CI=true` environment variable -- are authorized to deploy to these stages.

Attempting to deploy a protected stage locally produces an error:

```
SAFETY GUARD: Refusing to deploy to "prod" (tier: prod) from a local machine.
Production-tier stages can only be deployed via CI/CD.
Use a personal stage name (e.g., your first name) instead.
```

This applies to both `pulumi up` and `pulumi destroy` operations.

## Tier Validation

The system cross-checks the tier configuration against the stage name to prevent misconfiguration that could disable resource protection on known stages.

Specifically:
- Stage `prod` or `production` must resolve to tier `prod`
- Stage `dev` must resolve to tier `dev`
- Stage `staging` must resolve to tier `staging`

If someone manually set `devstride:tier: personal` on the `prod` stage (which would disable resource protection and enable `forceDestroy`), the deployment fails immediately:

```
SAFETY GUARD: Stage "prod" cannot have tier "personal".
This would disable resource protection. Remove the tier override from Pulumi config.
```

## Domain Validation

The production stage must use the `devstride.dev` domain. This prevents deployments with a misconfigured domain that could route production traffic to the wrong infrastructure.

```
SAFETY GUARD: Production stage must use "devstride.dev" domain,
but domain is set to "example.com". Check devstride:domain in Pulumi config.
```

## Resource Protection

Protection levels are determined by the stage's tier (ephemeral vs. non-ephemeral).

### Non-Ephemeral Stages (prod, dev, staging)

| Setting | Value | Effect |
|---------|-------|--------|
| `protect` | `true` | Pulumi refuses to delete or replace the resource. Must explicitly remove protection first. |
| `retainOnDelete` | `true` | Even if the resource is removed from code, the actual AWS resource survives. Prevents data loss from accidental code changes. |
| `recoveryWindowInDays` | `30` | Deleted Secrets Manager secrets are recoverable for 30 days. |
| `forceDestroy` | `false` | S3 buckets with contents cannot be deleted. Must empty first. |
| Log retention | `90` days | CloudWatch Logs retained for 90 days. |

### Ephemeral Stages (personal)

| Setting | Value | Effect |
|---------|-------|--------|
| `protect` | `false` | Resources can be freely deleted. |
| `retainOnDelete` | `false` | Removed resources are actually deleted from AWS. |
| `recoveryWindowInDays` | `0` | Secrets Manager secrets are deleted immediately (no recovery window, no 30-day cost). |
| `forceDestroy` | `true` | S3 buckets are deleted even if they contain objects. Clean teardown. |
| Log retention | `7` days | CloudWatch Logs retained for 7 days only. |

## Resource Tagging

All AWS resources are automatically tagged via a Pulumi stack transformation. Every resource whose type starts with `aws:` or `aws-native:` receives these tags:

```
devstride:stage     = phil
devstride:tier      = personal
devstride:managed-by = pulumi
devstride:ephemeral = true        (only for personal stages)
```

These tags serve three purposes:

1. **Cost tracking** -- Filter AWS Cost Explorer by `devstride:stage` to see per-developer costs.
2. **Automated cleanup** -- Scripts can identify and clean up stale resources by checking `devstride:ephemeral = true` tags.
3. **Resource identification** -- When investigating issues in the AWS console, tags immediately identify which stage and tier a resource belongs to.

## Shell Injection Prevention

The `ds` CLI validates stage names against a strict regex pattern:

```
/^[a-z][a-z0-9-]{1,19}$/
```

This means stage names must:
- Start with a lowercase letter
- Contain only lowercase letters, numbers, and hyphens
- Be between 2 and 20 characters long

The `store_bind.mjs` script (which reads Pulumi outputs) uses `execFileSync` instead of `exec` to prevent shell injection. Even if a stage name somehow bypassed the regex, `execFileSync` does not invoke a shell, so special characters cannot be interpreted as shell commands.

## Destructive Action Confirmation

The `./ds infra remove` command requires typing the stage name to confirm before proceeding:

```
WARNING: This will destroy all resources for stage "phil".
Type the stage name to confirm: phil
```

This prevents accidental teardowns from a mistyped command or running the wrong command in the wrong terminal. The `--dry-run` flag lets you preview what would be destroyed without any confirmation prompt.

## IAM Scoping

Lambda IAM policies are scoped to the stage's resource prefix wherever possible:

| Service | IAM Resource Pattern |
|---------|---------------------|
| DynamoDB | `arn:aws:dynamodb:*:*:table/{stage}-devstride-*` |
| S3 | `arn:aws:s3:::{stage}-devstride-*` |
| EventBridge | `arn:aws:events:*:*:event-bus/{stage}-devstride-*` |
| SNS | `arn:aws:sns:*:*:{stage}-devstride-*` |
| SQS | `arn:aws:sqs:*:*:{stage}-devstride-*` |
| Secrets Manager | `arn:aws:secretsmanager:*:*:secret:{stage}-devstride-*` and `arn:aws:secretsmanager:*:*:secret:devstride/{stage}/*` |
| CodeBuild | `arn:aws:codebuild:*:*:project/{stage}-devstride-*` |
| Cognito | Scoped to the specific user pool ARN when available |

Services that do not follow the naming convention (SES, CloudWatch Logs, Step Functions) use `Resource: '*'` out of necessity.
