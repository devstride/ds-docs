---
title: "Admin Guide"
description: "Setup guide for administrators managing cloud-dev infrastructure."
---

# Admin Guide

This guide covers administrative tasks for setting up and maintaining cloud-dev infrastructure.

## Secrets Management

Cloud-dev uses AWS Secrets Manager to store shared secrets that are distributed to developer environments.

### Initial Secrets Setup

1. Create a local `.env` file with all required secrets:

   ```bash
   # Copy the sample and fill in values
   cp .env.sample .env
   ```

2. Push secrets to AWS Secrets Manager:

   ```bash
   ./ds cloud-dev init-secrets
   ```

   This creates/updates the secret `devstride/shared-env` in AWS Secrets Manager.

3. Verify secrets were stored:

   ```bash
   ./ds cloud-dev list-secrets
   ```

### Required Secrets

The following secrets must be configured for cloud-dev environments to function:

| Category | Secrets |
|----------|---------|
| Core | `DOMAIN` |
| Pusher | `PUSHER_APP_KEY`, `PUSHER_APP_SECRET`, `PUSHER_APP_ID`, `PUSHER_APP_CLUSTER` |
| Stripe | `STRIPE_PUBLIC_KEY`, `STRIPE_SECRET_KEY` |
| GitHub | `GITHUB_APP_ID`, `GITHUB_CLIENT_ID`, `GITHUB_CLIENT_SECRET`, `GITHUB_APP_CERT`, `GITHUB_APP_NAME` |
| AI | `OPENAI_API_KEY` |
| Media | `GIPHY_API_KEY` |

### Optional Secrets

These enhance functionality but aren't required:

| Secret | Purpose |
|--------|---------|
| `CUBE_API_ENDPOINT` | Analytics integration |
| `SLACK_CLIENT_ID` | Slack app integration |
| `SENTRY_DSN` | Error tracking |

### Updating Secrets

When secrets change, update them:

```bash
# Edit your local .env with new values
# Then push to AWS
./ds cloud-dev init-secrets -f  # -f forces overwrite
```

Developers will get updated secrets on their next `create` or when running `setup-secrets`:

```bash
./ds cloud-dev setup-secrets  # Fetches latest secrets
```

---

## Neon Database Configuration

Enable auto-provisioning of Neon database branches for developers.

### Setup Neon API Access

1. Get a Neon API key from https://console.neon.tech/app/settings/api-keys

2. Store the API key and project ID in AWS Secrets Manager:

   ```bash
   aws secretsmanager create-secret \
     --name devstride/neon-api \
     --secret-string '{"apiKey":"neon_api_key_here","projectId":"your-project-id"}' \
     --profile devstride-admin
   ```

   Or update existing:

   ```bash
   aws secretsmanager put-secret-value \
     --secret-id devstride/neon-api \
     --secret-string '{"apiKey":"neon_api_key_here","projectId":"your-project-id"}' \
     --profile devstride-admin
   ```

3. Find your Neon project ID in the Neon Console URL or project settings.

### How Auto-Provisioning Works

When a developer runs `./ds cloud-dev create --auto-provision-db`:

1. Cloud-dev fetches the Neon API credentials from Secrets Manager
2. Lists existing branches to avoid duplicates
3. Creates a new branch named `dev-{developer-name}` from main
4. Generates connection credentials automatically
5. Configures the `.env` with the new connection string

### Managing Branches

View existing branches in the Neon Console or via API:

```bash
curl -H "Authorization: Bearer $NEON_API_KEY" \
  "https://console.neon.tech/api/v2/projects/$PROJECT_ID/branches"
```

Delete old branches when developers leave:

```bash
curl -X DELETE \
  -H "Authorization: Bearer $NEON_API_KEY" \
  "https://console.neon.tech/api/v2/projects/$PROJECT_ID/branches/$BRANCH_ID"
```

---

## Slack Notifications

Enable Slack notifications for environment events.

### Setup Webhook

1. Create a Slack App at https://api.slack.com/apps

2. Enable Incoming Webhooks and create a webhook for your channel

3. Store the webhook URL in AWS Secrets Manager:

   ```bash
   aws secretsmanager create-secret \
     --name devstride/slack-webhook \
     --secret-string '{"webhookUrl":"https://hooks.slack.com/services/..."}' \
     --profile devstride-admin
   ```

### Notification Events

| Event | Notification |
|-------|-------------|
| Environment created | Developer name, instance name, IP, region |
| Environment destroyed | Developer name, instance name |
| Setup error | Developer name, error details |

### Disabling Notifications

If the secret doesn't exist, notifications are silently skipped. To disable:

```bash
aws secretsmanager delete-secret \
  --secret-id devstride/slack-webhook \
  --profile devstride-admin
```

---

## AMI Management

Pre-built AMIs speed up instance creation by including all dependencies.

### Building an AMI

1. Create a clean instance:

   ```bash
   ./ds cloud-dev create --skip-setup
   ```

2. Connect and verify everything is installed:

   ```bash
   ./ds cloud-dev ssm

   # Verify Node.js
   source ~/.nvm/nvm.sh && node -v

   # Verify pnpm
   pnpm -v

   # Verify Claude
   which claude
   ```

3. Stop the instance for consistent state:

   ```bash
   ./ds cloud-dev stop
   ```

4. Build the AMI:

   ```bash
   ./ds cloud-dev build-ami
   ```

5. Wait for completion (10-15 minutes). The command will output the new AMI ID.

### Using Custom AMIs

After building, the new AMI ID is printed to the console. Update the cloud-dev infrastructure code to reference it, or pass it as a configuration parameter during instance creation.

### AMI Contents

The standard AMI includes:

- Amazon Linux 2023
- Node.js 22 LTS (via nvm)
- pnpm 9.x
- Docker
- AWS CLI v2
- Git
- Claude Code CLI
- VS Code CLI (for tunnels)
- tmux, htop, jq utilities
- Increased inotify limits

### Updating AMIs

Build new AMIs when:

- Node.js version changes
- Major pnpm updates
- New system dependencies needed
- Claude Code updates

Old AMIs can be deregistered after all developers update:

```bash
aws ec2 deregister-image --image-id ami-old-id
```

---

## Auto-Stop Configuration

Auto-stop helps reduce costs by stopping idle instances.

### Default Behavior

- Runs every hour via EventBridge
- Checks if CPU < 5% for the configured hours (default: 4)
- Stops instance if idle, preserving data

### Adjusting Thresholds

The auto-stop Lambda checks two key parameters:

- **CPU threshold**: 5% — if average CPU stays below this, the instance is considered idle
- **Idle hours**: Configurable via `--auto-stop` flag (default: 4) — how many consecutive hours of low CPU before stopping

### Monitoring Auto-Stop

Check CloudWatch Logs for the auto-stop Lambda:

```bash
aws logs tail /aws/lambda/devstride-dev-yourname-AutoStopLambda \
  --follow --profile devstride-admin
```

### Disabling Auto-Stop

Developers can disable during create:

```bash
./ds cloud-dev create --auto-stop 0
```

Or admins can remove the EventBridge rule from the stack.

---

## Cleanup and Maintenance

### Finding Orphaned Resources

Run the cleanup command to find resources without active stacks:

```bash
./ds cloud-dev cleanup
```

This scans for:
- EC2 instances
- VPCs
- Security groups
- Elastic IPs
- EventBridge rules
- Lambda functions

### Manual Cleanup

If cleanup command can't remove resources:

```bash
# List EC2 instances
aws ec2 describe-instances \
  --filters "Name=tag:Name,Values=devstride-dev-*" \
  --query 'Reservations[].Instances[].[InstanceId,Tags[?Key==`Name`].Value|[0],State.Name]' \
  --output table

# Terminate orphaned instance
aws ec2 terminate-instances --instance-ids i-xxxxx
```

### Cost Monitoring

Set up AWS Budgets to alert on cloud-dev spending:

1. Go to AWS Budgets in the console
2. Create a budget filtered by tag `devstride:component=dev-environment`
3. Set threshold alerts at 50%, 80%, 100%

---

## Security Considerations

### IAM Permissions

Cloud-dev instances use an instance profile with:

- Full SSM access (for management)
- Secrets Manager read access
- CloudWatch Logs write access
- EC2 describe (for auto-stop)

Review and restrict as needed in the cloud-dev infrastructure code.

### Network Security

Each instance gets:

- Dedicated VPC
- Security group allowing SSH (22) and app ports (3000, 3001, 5173)
- Outbound internet access

### Secrets Rotation

Rotate secrets periodically:

1. Update values in source systems (Stripe, GitHub, etc.)
2. Update local `.env`
3. Push to Secrets Manager: `./ds cloud-dev init-secrets -f`
4. Notify developers to run `./ds cloud-dev setup-secrets`

---

## Next Steps

- [Command Reference](/developer-docs/environment-setup/cloud-dev/commands) - All commands
- [Advanced Features](/developer-docs/environment-setup/cloud-dev/advanced-features) - Auto-stop, Neon, notifications
- [Troubleshooting](/developer-docs/environment-setup/cloud-dev/troubleshooting) - Common issues
