---
title: "ds db"
description: "Commands for database migrations, data management, repair scripts, and queries."
---

# ds db

Database operations. Requires AWS authentication (connection strings resolve from Secrets Manager).

All commands accept `--target <stage>` to specify which stage's database to operate on. Defaults to `$DEVSTRIDE_STAGE`.

::callout{type="warning"}
Destructive commands are blocked on protected stages (`prod`, `dev`, `staging`) from local machines. Only CI/CD pipelines can modify protected stages.
::

---

### db migrate

**Purpose:** Run pending Drizzle ORM database migrations.

**When to use:** After pulling code with new migrations, after generating a migration with `pnpm -C backend generate-sql`, or during initial setup.

| Option | Description |
|--------|-------------|
| `--target <stage>` | Target stage |
| `--sql-only` | Run SQL migrations only, skip DynamoDB |

::callout{type="info"}
Idempotent -- already-applied migrations are tracked and skipped automatically.
::

---

### db import

**Purpose:** Import data from a backup file into the target database.

**When to use:** To restore data from a previous export or load a specific data set for testing.

```bash
ds db import <path> [-t, --tables <tables>]
```

::callout{type="warning"}
Importing replaces existing data in the specified tables. Run `ds db export` first to preserve current data.
::

---

### db export

**Purpose:** Export data from the target database to a backup file.

**When to use:** Before destructive operations (wipe, reset), to create snapshots, or to share data with another developer.

```bash
ds db export [path] [-t, --tables <tables>]
```

If no path is given, exports to `.ds/data/<stage>/`.

---

### db wipe

**Purpose:** Delete all application data from the target database.

**When to use:** When you need a clean slate before importing fresh data, or when test data is corrupted.

```bash
ds db wipe [-t, --tables <tables>]
```

Requires typing the stage name to confirm.

::callout{type="danger"}
Permanent deletion. No undo. Always `ds db export` first.
::

---

### db purge-org

**Purpose:** Remove all data for a specific organization (users, items, boards, and all related records).

**When to use:** To remove a test organization without affecting other organizations in the database.

| Option | Description |
|--------|-------------|
| `-o, --organization <id>` | Organization ID to purge |

Requires confirmation. Blocked on protected stages.

---

### db repair aggregations

**Purpose:** Recalculate item rollup counts, sums, and progress values.

**When to use:** When dashboard numbers, progress bars, or rollup values appear incorrect. Aggregations can drift if events are processed out of order.

| Option | Description |
|--------|-------------|
| `-o, --organization <id>` | Limit to one organization |

::callout{type="info"}
Safe to run at any time. Items already correct are not modified.
::

---

### db repair hierarchy

**Purpose:** Recalculate parent-child relationships, depth, and path for all items.

**When to use:** When the item tree shows incorrect nesting, items appear under the wrong parent, or breadcrumb paths are wrong.

| Option | Description |
|--------|-------------|
| `-o, --organization <id>` | Limit to one organization |

---

### db repair dates

**Purpose:** Recalculate min/max date ranges across the item hierarchy.

**When to use:** When Gantt chart timelines show incorrect start/end dates for parent items. Parents derive ranges from children and these can drift.

---

### db repair orphans

**Purpose:** Delete items with no valid parent in the hierarchy.

**When to use:** When orphaned items exist from failed deletes or import issues.

::callout{type="warning"}
Permanently deletes orphaned items. Export first.
::

---

### db repair sidebar-defaults

**Purpose:** Add default sidebar form groups to organizations missing them.

**When to use:** After migrating organizations from an older schema version.

---

### db repair time-entries

**Purpose:** Migrate legacy `timeSpent` fields to the time entries system.

**When to use:** One-time migration for organizations with data in the old format.

::callout{type="info"}
Idempotent -- running multiple times does not create duplicates.
::

---

### db query active-emails

**Purpose:** List all active user email addresses in the target database.

**When to use:** For mailing lists, user audits, or billing reconciliation.
