---
title: "Infrastructure Commands"
description: "Commands for deploying and managing DevStride infrastructure."
---

# Infrastructure Commands

Commands for deploying, tearing down, and managing DevStride infrastructure via Pulumi.

## infra run

Deploy infrastructure changes with Pulumi.

```bash
./ds infra run
```

Runs `pulumi up --yes --skip-preview` against your personal stage. After a successful deployment, the local bind cache is automatically cleared so the next `ds` command picks up fresh Pulumi stack outputs.

The deployment targets the `infra/` directory and uses the stage from your `DEVSTRIDE_STAGE` environment variable.

::callout{type="info"}
This command deploys whichever stage is set in `DEVSTRIDE_STAGE`. It does **not** enforce a stage guard at the CLI level. Protected stages (`dev`, `prod`, `staging`) are deployed exclusively through CI/CD by convention; the pipeline enforces its own access controls.
::

## infra run-services

Start local Docker services required for development (e.g., DynamoDB Local).

```bash
./ds infra run-services
```

Runs `docker-compose up -d` to start containerized services. This command only operates when `IS_LOCAL=true` is set in the environment.

## infra remove

Complete teardown of a personal stage environment.

```bash
./ds infra remove [options]
```

**Options:**

| Option | Description |
|--------|-------------|
| `--keep-stack` | Keep Pulumi stack state (skip `pulumi stack rm`) |
| `--skip-neon` | Skip Neon database branch cleanup |
| `--dry-run` | Show what would be cleaned up without executing |

**Steps performed:**

1. Prompt for stage name (pre-filled with current `DEVSTRIDE_STAGE`)
2. Stage guard validation (blocks protected stages)
3. Require explicit confirmation (type the stage name to confirm)
4. Run `pulumi destroy` to remove all AWS resources
5. Post-destroy cleanup:
   - Delete Neon database branch (unless `--skip-neon`)
   - Remove Pulumi stack state (unless `--keep-stack`)
   - Clean local bind cache (`.ds/bind/`)
   - Clean setup state (`~/.devstride/setup-state.json`)
   - Remove Pulumi config file

A teardown summary is printed at the end showing the status of each cleanup step.

**Dry run example:**

```bash
./ds infra remove --dry-run
```

This shows the full teardown plan without making any changes.

::callout{type="danger"}
This permanently destroys all AWS resources for the stage. Data cannot be recovered. Always use `--dry-run` first if you are unsure what will be removed.
::

## infra pause

Pause a personal stage to save AWS costs when not actively developing.

```bash
./ds infra pause
```

This command:

1. Scans all Lambda functions in your region
2. Identifies functions belonging to your stage by checking the `DEVSTRIDE_STAGE` environment variable on each function
3. Lists the matched functions and asks for confirmation (type `yes`)
4. Sets reserved concurrency to **0** on every matched function

With reserved concurrency set to 0, Lambda functions stop accepting invocations entirely. API Gateway will return errors for any requests, and EventBridge/SQS triggers will not invoke handlers.

::callout{type="info"}
Only personal stages can be paused. The stage guard blocks this command for `dev`, `prod`, and `staging`.
::

**Example output:**

```
Looking up Lambda functions for stage "phil" in us-east-1...

Found 12 Lambda function(s):
  - phil-devstride-api
  - phil-devstride-events
  - phil-devstride-jobs
  ...

This will set reserved concurrency to 0 on 12 Lambda function(s) for stage "phil".
All functions will stop accepting invocations until resumed.

Type "yes" to confirm:
```

## infra resume

Resume a paused personal stage, restoring all Lambda functions to accept invocations.

```bash
./ds infra resume
```

This command removes the reserved concurrency setting from all Lambda functions belonging to your stage. Functions return to using the account's unreserved concurrency pool and begin accepting invocations immediately.

The same stage guard and function discovery logic from `infra pause` applies, but there is no confirmation prompt -- functions are resumed immediately after discovery.

**Example output:**

```
Looking up Lambda functions for stage "phil" in us-east-1...

Found 12 Lambda function(s) to resume:
  - phil-devstride-api
  - phil-devstride-events
  ...

Resuming functions...

  [done] phil-devstride-api
  [done] phil-devstride-events
  ...

=== Resume Summary ===
  Stage:     phil
  Resumed:   12

All functions are now accepting invocations.
```

## admin list-stages

Discover all deployed Pulumi stages and identify stale ones.

```bash
./ds admin list-stages [options]
```

**Options:**

| Option | Description |
|--------|-------------|
| `--region <region>` | AWS region to scan (default: `us-east-1`) |
| `--stale-days <days>` | Days since last deploy to flag as stale (default: `14`) |

This command scans all Lambda functions in the AWS account and groups them by stage name using the `{stage}-devstride-{resource}` naming convention. It produces a table showing:

| Column | Description |
|--------|-------------|
| STAGE | The stage name (e.g., `prod`, `dev`, `phil`) |
| TIER | Environment tier: `prod`, `staging`, `dev`, or `personal` |
| LAMBDAS | Number of Lambda functions belonging to the stage |
| LAST DEPLOY | Timestamp of the most recently modified function |
| AGE | Days since last deployment |
| FLAGS | `STALE` if the stage is personal and exceeds the stale threshold |

Stale stages are personal stages that have not been deployed for longer than the `--stale-days` threshold. The command suggests cleanup instructions for any stale stages found:

```
Stale personal stages can be cleaned up with:
  DEVSTRIDE_STAGE=<stage> ./ds infra remove
```

::callout{type="info"}
Only personal stages are flagged as stale. Protected tiers (`prod`, `staging`, `dev`) are never flagged regardless of age.
::
